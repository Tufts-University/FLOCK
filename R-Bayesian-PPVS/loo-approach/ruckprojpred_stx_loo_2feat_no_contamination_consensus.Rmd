---
title: "STX Score Ruck Variable Selection with PPVS - LOO Methodology (2 Features)"
author: "Aaron Gardony"
date: "10/17/2023"
output: pdf_document
classoption: landscape
editor_options:
  chunk_output_type: inline
---

# Setup

## Read in libraries

```{r import libraries, echo=TRUE, message=FALSE, warning=FALSE}
renv::activate()
library(rmarkdown)
library(data.table)
library(ggplot2)
library(brms)
library(emmeans)
library(lme4)
library(tictoc)
library(mosaic)
library(priorsense)
library(afex)
library(kableExtra)
library(viridis)
library(tidyverse)
library(modelr)
library(bayestestR)
library(effectsize)
library(tidybayes)
library(gridExtra)
library(projpred)
library(showtext)
library(tinytex)
library(recipes)
library(extrasteps)# for robust scale equivalent
# devtools::install_github("EmilHvitfeldt/extrasteps")
library(tictoc)
library(brmstools)
# devtools::install_github("mvuorre/brmstools")
library(beepr)
```
\newpage

## Read in ruck data    

```{r read data and set up, message=FALSE, warning=FALSE}
ruck_data <- fread("data/AllRuckFeatures.csv", header=TRUE)
ruck_data %>% filter(Platoon_Squad != "PLT6SQ1") -> ruck_data
ruck_data <- ruck_data %>%
  remove_rownames() %>% 
  column_to_rownames(var="Platoon_Squad") %>% 
  select(-c('recon_score','raid_score'))
ruck_data <- ruck_data %>% slice(-c(3,5,14))
ruck_data %>% ggplot(aes(x = stx_score)) + geom_halfeyeh()
all_pred = c()
showtext_auto()
set.seed(8675309) # set random seed for reproducible results
#load("ruckprojpred_stx_loo_2feat_no_contaminationEnv.RData") # uncomment when knitting
```
\newpage

# Projection Predictive Variable Selection (PPVS)

For more details see: <https://mc-stan.org/projpred/articles/projpred.html>

In projpred, projection predictive variable selection consists of a search part and an evaluation part. The search part determines the solution path, i.e., the best submodel for each submodel size (number of predictor terms). The evaluation part determines the predictive performance of the submodels along the solution path.

## Find best 2-feature submodel for each loo fold

```{r compute best fit model, eval=FALSE, include=TRUE}
tic()
# across models we will set a weakly informative prior for the beta coefficients
prior <- c(set_prior("normal(0,100)", class = "b"))

for (i in 1:nrow(ruck_data)) {
  left_out_squad = i
  ruck_data_train <- ruck_data %>% slice(-left_out_squad)
  
  # 1: perform robust scaling mimicing scikit RobustScaler on the training data for this iteration
  rec <- recipe(stx_score ~., data = ruck_data_train) %>% 
    step_robust(all_numeric_predictors()) %>% 
    prep()
  
  assign(paste0("ruck_data_train_",i),
         rec %>% 
           bake(new_data = NULL))

  # 2: perform robust scaling mimicing scikit RobustScaler on the test datum for this iteration
  assign(paste0("ruck_data_test_",i),
         rec %>% 
           bake(new_data = ruck_data %>% slice(left_out_squad)))
  
  # fit the maximal model (all predictors), store in ref_fit_i
  
  assign(paste0("ref_fit_",i),
         brm(stx_score ~ (.),
             family = gaussian(),
             data = get(paste0("ruck_data_train_",i)),
             prior = set_prior(R2D2()), # set a shrinkage prior, like horseshoe or R2D2
             backend = "cmdstanr",
             seed = 8675309,
             refresh = 0,
             iter = 4000,
             cores = 4,
             chains = 4,
             silent=2,
             control = list(adapt_delta = 0.99999)))
  
  # 2 feature forward search with projpred/cv_varsel, store result in cvvs_i
  assign(paste0("cvvs_",i),
         cv_varsel(
           get(paste0("ref_fit_",i)),
           method = "forward",
           nterms_max = 2,
           seed = 8675309
           ))
         
  # get the 2 solution terms, store them in soltrm_i
  assign(paste0("soltrms_",i),
         solution_terms(get(paste0("cvvs_",i))))
  
  # store the resulting regression formula in formula_i 
  assign(paste0("formula_",i),
         paste("stx_score~",paste(get(paste0("soltrms_",i)),collapse='+'),collapse = ''))
  
  assign(paste0("fit_",i),
       brm(formula = get(paste0("formula_",i)),
           family = "gaussian",
           data = get(paste0("ruck_data_train_",i)),
           prior=prior, # weakly informative priors
           backend = "cmdstanr",
           seed = 8675309,
           refresh = 0,
           iter = 4000,
           cores = 4,
           chains = 4,
           silent=2,
           control = list(adapt_delta = 0.99999)))

  pp_loo <- predict(get(paste0("fit_",i)), newdata = get(paste0("ruck_data_test_",i)))
  all_pred[left_out_squad] = pp_loo[,1]
}

predictVsObs = data.frame("obs" = ruck_data$stx_score,
                          "pred" = all_pred,
                          "error" = abs(ruck_data$stx_score - all_pred))
toc()
```
# Evalute predictive performance across LOO folds
```{r}
library(ggpubr)
avgError = mean(predictVsObs$error)
ggplot(predictVsObs, aes(x = obs, y = pred)) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1) +
  geom_text(aes(x = obs + 1.3, label = as.integer(row.names(predictVsObs)))) +
  labs(title = "Bayesian PPVS for STX SCORE - LOO Approach",
       x = "Observed", y = "Predicted") + 
  lims(x = c(0,130), y = c(0,130))+
  annotate(geom="text", x=16, y=78, label=paste("Mean Error:",round(avgError,2),"%",sep=""), color="red")
```
\newpage
```{r}
# make formula list
formula_list = c()
for (i in 1:nrow(ruck_data)) {
  formula_list[i] = get(paste0("formula_",i))
}
formula_list
```


\newpage

# Session Info

```{r session info}
library(sessioninfo)
sessioninfo::session_info(to_file=TRUE)
print(cmdstanr::cmdstan_version(error_on_NA = FALSE))
```
